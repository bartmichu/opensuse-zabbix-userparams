# https://github.com/bartmichu/opensuse-zabbix-userparams
#
# OpenSUSE system monitoring.
#
# Usage:
# - Copy userparams file (opensuse-userparams.conf) to a directory included in your Zabbix Agent configuration file, e.g. /etc/zabbix/zabbix_agentd.d/ or /etc/zabbix/zabbix_agent2.d/
# - Set userparams file owner and group (chown root:zabbix opensuse-userparams.conf)
# - Set userparams file mode (chmod 0440 opensuse-userparams.conf)
# - Copy corresponding sudoers file (opensuse-userparams-sudoers) to /etc/sudoers.d/ directory
# - Set sudoers file mode (chmod 0440 /etc/sudoers.d/opensuse-userparams-sudoers)
# - Restart Zabbix Agent (systemctl restart zabbix-agent.service or systemctl restart zabbix-agent2.service)
# - Import corresponding template file (opensuse-userparams-template.yaml) on Zabbix Server
# - Link 'Template opensuse-userparams by Zabbix agent active' template to selected hosts
# - You may need to increase the Timeout value in your Zabbix Agent configuration file, e.g. Timeout=30
#
# System requirements:
# - sudo package installed (installed by default on Leap 15.3) for some checks
# - rebootmgr package installed and rebootmgr.service running for some checks
#
# Tested on:
# - Zabbix Agent and Zabbix Agent 2 on openSUSE Leap 15.3
# - Zabbix Server 5.x
#


# Return version number of this file.
# Used internally within the template.
UserParameter=opensuse-userparams.userparams-version,echo 7


# Check if the reboot-needed flag was set by a previous update or install of a core library or service.
# This flag indicates that reboot is required to ensure that your system benefits from these updates.
#
# Expected return value:
#  1 - reboot is needed
#  2 - reboot is not needed
UserParameter=opensuse-userparams.reboot.needed,/usr/bin/zypper needs-rebooting 2>/dev/null 1>/dev/null && /usr/bin/echo 2 || /usr/bin/echo 1


# Check if system reboot is requested from reboot manager.
# Requires sudo and rebootmgr.
#
# Expected return value:
#  1 - reboot requested
#  2 - reboot not requested
UserParameter=opensuse-userparams.reboot.requested,/usr/bin/sudo /usr/sbin/rebootmgrctl status --quiet 2>/dev/null 1>/dev/null && /usr/bin/echo 2 || /usr/bin/echo 1


# Get the number of services which are using meanwhile deleted files (e.g. shared libraries).
# These services may need to be restarted after an update. Requires sudo.
#
# Expected return value: number indicating the number of services.
UserParameter=opensuse-userparams.services.restart,/usr/bin/sudo /usr/bin/zypper ps -sss | /usr/bin/wc -l


# Get the number of all available updates.
#
# Expected return value: number indicating the number of updates.
UserParameter=opensuse-userparams.updates.all,/usr/bin/zypper --no-refresh list-updates | /usr/bin/grep ' | ' | /usr/bin/tail -n +2 | /usr/bin/wc -l


# Get the number of all applicable patches, including security patches.
#
# Expected return value: number indicating the number of patches.
UserParameter=opensuse-userparams.patches.all,/usr/bin/zypper --no-refresh list-patches | /usr/bin/grep -c -i '| needed'


# Get the number of applicable security patches.
#
# Expected return value: number indicating the number of security patches.
UserParameter=opensuse-userparams.patches.security,/usr/bin/zypper --no-refresh list-patches --category security | /usr/bin/grep -c -i '| needed'


# Get the number of applicable critical patches.
#
# Expected return value: number indicating the number of critical patches.
UserParameter=opensuse-userparams.patches.critical,/usr/bin/zypper --no-refresh list-patches --severity critical | /usr/bin/grep -c -i '| needed'


# Get the number of applicable interactive patches.
# Patches are interactive when they need reboot, contain a message, or update a package whose license needs to be confirmed.
#
# Expected return value: number indicating the number of interactive patches.
UserParameter=opensuse-userparams.patches.interactive,/usr/bin/zypper --no-refresh list-patches | /usr/bin/grep -i '| needed' | /usr/bin/cut -d '|' -f 5 | /usr/bin/grep -c -v -i '\---'


# Check if system was shut down gracefully before current boot.
#
# Expected return value:
#  1 - ungraceful shutdown
#  2 - graceful shutdown
UserParameter=opensuse-userparams.graceful-shutdown,/usr/bin/last -Fxn2 shutdown reboot | /usr/bin/cut -d ' ' -f 1 | /usr/bin/grep -c -i 'shutdown' 2>/dev/null 1>/dev/null && /usr/bin/echo 2 || /usr/bin/echo 1
